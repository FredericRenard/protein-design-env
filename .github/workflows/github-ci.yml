name: Reax pipeline

on: [pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/catthehacker/ubuntu:runner-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "0.5.5"
    - name: Set up Python
      run: uv python install 3.10.15
    - name: Install the project
      run: uv sync --all-extras --dev
    - name: Test with pytest
      run: uv run -n pytest --cov=src --cov-report xml:coverage/coverage.xml
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/coverage.xml
    - name: Code Coverage Summary Report
      uses: irongut/CodeCoverageSummary@v1.3.0
      with:
        badge: true
        output: both
        filename: coverage/coverage.xml
        fail_below_min: true
        format: markdown
        thresholds: '60 80'
    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        recreate: true
        path: code-coverage-results.md

  lint:
     runs-on: ubuntu-latest
     steps:
        - uses: actions/checkout@v4
        - name: Install uv
          uses: astral-sh/setup-uv@v4
          with:
            version: "0.5.5"
        - name: Set up Python
          run: uv python install 3.10.15
        - name: Install the project
          run: uv sync --only-dev
        - name: Install hooks and run pre-commit
          run: |
            uv run pre-commit install-hooks &&
            uv run pre-commit run --all-files
